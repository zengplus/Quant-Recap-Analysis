# **实验日记 (Experiment Log) - V0.2**

> **日期**: 2026-02-11  
> **版本**: V0.2  
> **主题**: **奖励函数与时间窗划分的重构**  
> **状态**: 完成

## **1. 核心发现**

### **1.1 问题的发现：V0.1时间划分的局限性**
在V0.1解决了回测一致性基础问题后，我最初沿用了原有的时间划分体系，即"原三段"评估框架：
- **原三段（短窗）训练段(train)**：2020-2023年
- **原三段（短窗）验证段(valid)**：2024年
- **原三段（短窗）测试段(test)**：2025年
  
随后我也尝试过把训练段扩展成更长窗口来提升稳定性：
- **原三段（长窗）训练段(train)**：2014-2023年
- **原三段（长窗）验证段(valid)**：2024年
- **原三段（长窗）测试段(test)**：2025年

**关键观察**：
- 在验证段（2024年）表现最佳的模型，在测试段（2025年）往往表现不佳
- 即使将训练时间扩展到2014-2023年（增加历史数据），情况仍未根本改善
- 通过多次调整`model_core/config.py`中的奖励函数参数（如增加`NEG_EXCESS_PENALTY`），仍无法保证模型在三段时间的超额收益均为正

**数据证据**：
- 多数实验结果显示，模型在至少一个时间段出现负超额收益
- 验证集和测试集的表现呈现出明显的"跷跷板效应"：验证集表现好则测试集表现差，反之亦然
- 不同`seed`的结果差异巨大，导致"能跑出一个通过seed，但难以复现到多个seed同时通过"

### **1.2 问题的定位：2025年的"特殊性"**
通过深入分析市场数据，发现了问题的本质：

**2024年与2025年的市场结构对比**：
- **2024年**：整体呈现熊市特征，虽然年末有急速拉伸，但全年基准收益为负
- **2025年**：呈现明显的牛市特征，基准收益为正且涨幅显著

**根本矛盾**：
- 验证集（2024年）的最佳模型是在熊市环境中选出的
- 测试集（2025年）是牛市环境，两者市场结构完全不同
- 这导致了"在熊市表现最好的策略，在牛市可能不是最优甚至可能失效"

**2025特殊性体现**：
- 用 2014-2019 或 2020-2024 学到的选股结构，在 2025 更容易失配
- 市场风格/波动结构变化会改变"哪些特征组合"对收益更有效
- 强化学习(REINFORCE)本身高方差，使得模型更容易在特定年份的噪声上"押注"

### **1.3 验证实验：分段验证的尝试与失败**
为了应对上述问题，我尝试了分段验证方法，对验证期进行子段拆分：

**实验设置**：
- 将验证期拆分为多个子段（半年/季度级别）
- 使用 `valid_agg=min` 聚合来选择best（即"最差子段也不能太差"）
- 试图通过更精细的验证来选择更具泛化能力的模型

**实验结果**：
- **部分成功**：分段验证确实筛选出了在验证期内表现更稳定的模型
- **根本失败**：即使如此，这些模型在2025年测试集上仍经常出现负超额收益
- **关键发现**：仅仅在验证期内包含多种市场状态，仍无法保证模型能适应全新的市场结构

**失败原因分析**：
1. **样本量有限**：验证期（2024年）本身时间较短，即使分段也难以覆盖所有可能的市场状态
2. **结构变化**：2025年的市场结构可能与历史任何时期都不同，无法通过历史数据完全模拟
3. **过拟合风险**：模型可能过拟合了验证期内的特定模式，而非学习到真正的Alpha

### **1.4 突破性发现：验证集与测试集的根本角色冲突**
通过一系列失败的实验，我认识到一个关键问题：

**验证集与测试集的时间邻近性导致的选择偏置（近邻结构相关性）**：
- 在传统的"训练-验证-测试"划分中，验证集用于挑选最优公式/最优checkpoint
- 但当验证集（2024年）与测试集（2025年）时间上紧邻时，容易出现“把策略选到刚好适配相邻结构”的选择偏置
- 即使没有任何显式的数据泄露，近邻年份之间的市场结构相关性也会让“验证最优”不等价于“真正稳健”

**市场结构连续性问题**：
- 相邻年份的市场结构通常具有一定的连续性
- 如果验证集紧邻测试集，那么验证集上的最佳模型可能只是适应了"即将过时"的市场结构
- 这解释了为什么验证集上的最佳模型在测试集上表现不佳

### **1.5 解决方案：三段评估体系的重构**
基于以上发现，我提出了全新的三段评估体系：

**核心思想**：
1. **完全隔离测试集**：将2025年彻底从训练和验证过程中剥离
2. **增加缓冲期**：在验证集和测试集之间增加一个"最终验证集(holdout)"
3. **专注稳健性**：验证集专门设计为检验策略在不利市场条件下的表现

**新体系设计**：
- **训练段(train)**：2014-2019年（远离测试集，避免近期市场结构影响）
- **验证段(valid)**：2020-2022年（专门检验熊市表现）
- **最终验证段(holdout)**：2023-2024年（近期样本外验证，但不直接用于模型选择）
- **压力测试**：2025年（完全独立的最终测试）

### **1.6 指标与验收口径（把目标写清楚，避免口径漂移）**
为了避免“只写现象不写判定规则”，这里把本版本使用的核心指标统一下来：
- 记基准收益为 **B**，策略总收益为 **T**，策略超额为 **E**，则恒有 **T = B + E**
- **牛市/基准为正（B ≥ 0）**：验收要求 **E > 0**（跑赢基准）
- **熊市/基准为负（B < 0）**：验收要求 **E > 0 且 T > 0**，等价于 **E > |B|**（不仅要跑赢，还要把基准下跌吃回来并转正）
  
回测汇总表里常用字段对应关系为：
- `BenchReturn%` ↔ B
- `TotalReturn%` ↔ T
- `ExcessReturn%` ↔ E

## **2. 关键改动**

### **2.0 时间线概览**
本版本不是一次性"拍脑袋换切分"，而是按问题逐步推进：
1. 先在"原三段(train/valid_all/test_2025)"框架下做多seed复现，确认"可行解存在但稀疏"；
2. 尝试用奖励函数把模型"往2025方向拉"，并验证其副作用；
3. 发现"强行锁定2025"会带来方法论与工程风险后，改为"2023-2024 holdout + 2025压力测试"；
4. 把验收口径从"每段超额都正"改为"牛熊规则"，并统计多seed通过率，确认现状：通过少且对seed极敏感。

### **2.1 奖励函数试验：从"强惩罚负超额"到"避免被极端月噪声绑架"**
本版本尝试了对奖励函数做"稳健性增强"，核心思路是：
- 在`model_core/ashare_backtest.py`的`evaluate()`中对负向超额/负向绝对收益加入惩罚项；
- 额外加入"分段最差/尾部段"相关项，逼迫策略在所有月份不要太差。

#### **2.1.1 为什么当时要做"强行拟合2025超额"的方向性改动？**
当时的直觉是：2025经常不通过，说明模型可能在训练目标上缺少对"未来牛市/特定状态"的偏好，因此尝试：
- 增强"超额为负"的惩罚，逼迫模型少做"跑输基准但绝对收益还行"的解；
- 对某些市场状态（例如更偏牛市的阶段）提高权重，期待能改善2025的表现。

#### **2.1.2 实际做过哪些reward相关代码改动？**
做过的方向性改动包括（以配置注入方式实现，便于回滚/对照）：
- 增加负超额惩罚：`NEG_EXCESS_PENALTY`
- 增加负绝对收益惩罚：`NEG_PORT_PENALTY`
- 增加"分段尾部"稳健项：`MIN_EXCESS_WEIGHT`与`TAIL_SEG_FRACTION`（用最差/尾部子段均值约束）
- 在`model_core/ashare_engine.py`中把这些参数传入回测评估模块，确保训练使用同一套score口径

额外的"面向2025的尝试"还包含过：
- 对更偏"牛市/强势市场"的状态提高alpha相关权重（通过`ALPHA_WEIGHT_BULL`/`ALPHA_WEIGHT_BEAR`与`MARKET_REGIME_THRESHOLD`控制），避免模型只学到"熊市里跌得少"但在2025反弹期跑输的结构

使用过的代表性配置（用于对照试验，不代表最终结论）：
- `NEG_EXCESS_PENALTY`：从0提升到5.0/7.0级别做过尝试，观察收敛与通过率变化
- `ALPHA_WEIGHT_BULL`：例如1.5/1.8级别（把更偏牛市阶段的alpha权重放大）
- `TAIL_SEG_FRACTION`：0.2（取最差20%子段的均值作为稳健项）

#### **2.1.3 结果：为什么没有继续沿着reward强行锁定？**
实验现象非常明确：
- 当稳健项/惩罚项较强时，ValidBest极易被"极端差月份"主导；
- 训练过程会倾向于寻找"避免极端坏值"的策略，而不是寻找"整体有alpha的策略"，导致更难收敛到可用公式；
- 最终并没有出现"3个seed在原三段(train/valid_all/test_2025)都通过"的局面。

因此，本阶段的结论是：
- **奖励函数可以引导方向，但不适合用过硬的惩罚强行把所有seed都压进同一个解**；
- 更有效的方法是：把"牛熊规则"当成**验证门槛(gate)**或**多阶段筛选规则**，让搜索仍然有自由度，但最终输出满足约束。

### **2.2 回测口径一致性：确保TOPK等参数不漂移**
为了避免"训练/回测配置不一致导致误判"，对回测入口进行了参数取值口径统一：

**关键改动**：
- 在`run_pipeline.py`中统一多周期回测入口读取`ModelConfig.TOPK`，避免TOPK修改不生效导致的误判
- 确保回测持仓数从全局配置读取（避免改了TOPK但回测没生效）
- 本版本默认以`backtest_mode=joinquant_like`回测口径做多周期对照，避免线上线下交易规则差异再一次把"模型问题"和"回测口径问题"混在一起

#### **2.2.1 代码改动清单**
本版本相关代码改动主要集中在以下文件：
- `model_core/config.py`：新增/调整reward相关超参数（惩罚、尾部稳健项等），并在对照完成后回退默认值
- `model_core/ashare_backtest.py`：在`evaluate()`内加入负向惩罚与"尾部子段"稳健项的计算逻辑
- `model_core/ashare_engine.py`：将配置参数透传给回测/评估对象，保证训练评分口径一致
- `run_pipeline.py`：统一多周期回测入口读取`ModelConfig.TOPK`，并用于多seed/多分段训练实验的驱动

### **2.3 训练/验证窗口调整：把2023-2024从"训练验证"剥离成holdout**
相较V0.1更强调"2025对齐"，本版本更强调：
- 先在2020-2024内构建一个满足牛熊规则的稳定策略集合；
- 再评估它在2025的穿透能力，而不是让2025直接决定训练方向。

实践上，这个调整直接改变了"模型在训练时会被什么信号引导"：把2023-2024从训练可见区域挪出去后，模型需要先在2020-2022的熊市环境下学到"E>|B|"的能力，否则无法通过valid gate，避免了"只在2023-2024好看"的选择偏置。

### **2.4 修改验证时间时遇到的问题：指标约束在熊市段的"可行性"**
在把验证期改为2020-2022，并把2023-2024设为holdout的过程中，出现过一次"约束定义不严谨"带来的误判：
- 一度提出"若超额收益E为正，则总收益T要比超额E更高"；
- 但由于恒等式**T = B + E**，当基准收益**B<0**（熊市）时，会必然出现**T < E**；
- 这意味着这条约束等价于"熊市段要求基准B>0"，逻辑上自相矛盾。

最终把目标修正为"牛熊规则"，并明确熊市段要求的是：
- **E>0且T>0**（等价于**E>|B|**）

### **2.5 为什么没有继续"强行锁定2025分段学习"？**
当我们尝试直接把2025当作最终判定目标时，会同时遇到方法论与工程上的风险：
- **方法论风险**：如果训练/挑选策略的过程持续围绕2025调整（不管是调reward还是调数据切分），很容易变成"用测试集调参"，即使表面上没有直接训练在2025，也会发生选择偏置；
- **工程风险**：在REINFORCE高方差场景里，强行对单一年份施加强硬约束（尤其通过惩罚项）容易被极端月份/噪声支配，反而降低可行解的搜索效率。

因此V0.2采取折中策略：
- 用2023-2024作为holdout来定义"可行性与稳定性"；
- 把2025作为压力测试，而不是训练目标本身。

## **3. 结果分析**

### **3.0 扩展后的原三段（train / valid_all / test_2025）的多seed复现结论**
在上一节的“原三段（短窗/长窗）”均失败后，我还做过一个更贴近“跨周期稳健性”的扩展版三段，用来验证“可行解是否存在且是否稀疏”：
- **train**：2014-2019
- **valid_all**：2020-2024
- **test_2025**：2025
  
在该框架下做多seed复现时，出现的典型现象是：
- **可以跑出单个seed通过**（说明解空间内存在可行解）；
- 但很难出现"多个seed同时三段都正"的局面（说明可行解稀疏，且受seed影响巨大）；
- `TOPK=10`与`TOPK=20`会影响通过seed的分布（同一公式/同一学习路径对持仓规模敏感）。

这一步的结论非常关键：它否定了"2025根本不可能通过"的直觉，但也否定了"调一点reward就能必过"的直觉。

#### **3.0.1 原先为什么"怎么都达不到三段都为正"？**
从现象上看，失败主要集中在两类：
- **类型A：test_2025超额为负**  
  在valid_all(2020-2024)表现好的策略，到了2025失配，出现跑输基准（E<0）。
- **类型B：train超额为负**  
  有些策略在2020-2024（尤其是某些子段）能跑出正超额，但在2014-2019的结构里反而跑输，说明它更像"阶段性风格押注"而不是跨周期alpha。

这也是为什么后续我们必须引入"牛熊规则"与更严格的验证分段：只看valid_all的平均值，很容易选到"只在某两段牛市好看"的策略。

#### **3.0.2 当时为了"强行把2025超额拟合上去"做过什么时间选择？为什么没成功？**
当时的想法是：既然2025更像牛市/反弹环境，那就让验证期更多覆盖"牛市结构"，把策略往"牛市也能跑赢"的方向推。

因此在验证期设计上做过类似下面的组合（示意口径）：
- **训练段**：2014-2019（固定）
- **验证子段**：把2020-2021的更偏牛市阶段拆成多个半年段，并在验证聚合时提高其影响；同时加入2024（基准较强）作为"牛市样本"  
  直观上就是"牛市样本多一些+其他时间做兜底"，希望2025不再掉链子。

实际结果是：
- 确实能看到某些seed在test_2025上变好；
- 但往往会出现"**三段里仍有一段不为正**"的情况（常见是train或valid_all某段变负），即典型的"按住葫芦浮起瓢"；
- 且多seed复现仍然很差，说明这更像"对特定结构的过拟合"，无法形成稳定通过概率。

### **3.1 固定分段（train/valid/holdout）下的通过情况**
在三段框架下（train 2014-2019 / valid 2020-2022 / holdout 2023-2024），并使用"牛熊规则"判定，通过的种子是存在的，但概率不高，符合"稀有可行解"的特征。

已观测到的典型情况：
- 有些种子能在valid（熊市基准为负）实现**E > |B|**且**T > 0**，说明策略在熊市具备"真超额"；
- 但不少种子会在train（牛市）阶段出现**E < 0**，即使绝对收益为正也会跑输基准，从而不满足规则；
- 换种子重跑后，能看到"通过/不通过"的波动，说明当前训练仍存在较强的随机性。

### **3.2 当前现实：三段都符合标准的很少，且对随机种子极其敏感**
在当前配置（train 2014-2019 / valid 2020-2022 / holdout 2023-2024，牛熊规则判定）下，观测到的现象是：
- 三段都通过的策略确实存在，但属于"稀疏可行解"；
- 换随机种子后结果波动很大：有的seed能在熊市段做到**E>|B|且T>0**，有的seed在训练段就会出现**E<0**；
- 这与金融数据的低信噪比、REINFORCE的高方差特性一致。

### **3.3 经验统计：多次换seed的通过率**
把不同轮次的seed合并统计（同一三段规则）：
- 观测到通过的seed：20240202、20240303、20240909
- 观测到未通过的seed：20240101、20240505、20240606、20240707、20240808、20241010
- 当前样本内通过率约为**3/9**（仅用于体现"概率事件"特征，不代表最终真实通过率）

#### **3.3.1 通过样本的"数值证据"（三段都满足牛熊规则）**
为了避免"只写结论不写证据"，这里记录3个通过seed的关键数值（joinquant_like；单位为百分比）：

| Seed | Train(2014-2019) B | Train E | Valid(2020-2022) B | Valid E | Valid T | Holdout(2023-2024) B | Holdout E | 备注 |
| ---- | ------------------ | ------- | ------------------ | ------- | ------- | -------------------- | -------- | ---- |
| 20240202 | +75.8169 | +18.0565 | -5.4912 | +6.4541 | +0.9628 | +1.6344 | +22.1955 | 熊市段满足E>|B|且T>0 |
| 20240303 | +75.8169 | +9.3372  | -5.4912 | +20.9748 | +15.4835 | +1.6344 | +31.7947 | 熊市段裕度更大 |
| 20240909 | +75.8169 | +8.4902  | -5.4912 | +28.1658 | +22.6746 | +1.6344 | +10.5187 | 新seed中命中通过 |

解释：
- train与holdout属于"牛市/基准为正"的情况，规则是E>0；
- valid属于"熊市/基准为负"的情况，规则是E>0且T>0（等价于E>|B|），表中三者均满足。

#### **3.3.2 本版本的训练配置（用于复现实验）**
为保证实验可重复，本版本多seed复现实验中常用的一组配置是：
- `train_steps=300`
- `max_formula_len=12`
- `batch_size=128`（在显存与速度之间折中）
- `valid_agg=min`（拆分多个valid子段，用最差子段约束best选择）
- `token_mode=postfix`
- `backtest_mode=joinquant_like`

对应的输出目录按"时间切分+valid子段拆分+聚合方式+steps/len+seed"命名，便于后续汇总统计与回溯。

一个可直接复现“三段+压力测试汇总表”的最小示例（Python 方式调用）是：

```python
from run_pipeline import train_ashare, run_multi_backtest

seed = 20240202
output_dir = f"outputs/v0.2_repro_seed_{seed}"

formula, *_ = train_ashare(
    train_start="2014-01-01",
    train_end="2019-12-31",
    valid_start="2020-01-01",
    valid_end="2022-12-31",
    valid_periods=[
        ("2020-01-01", "2020-12-31"),
        ("2021-01-01", "2021-12-31"),
        ("2022-01-01", "2022-12-31"),
    ],
    valid_agg="min",
    instruments="csi300",
    batch_size=128,
    train_steps=300,
    max_formula_len=12,
    output_dir=output_dir,
    seed=seed,
    token_mode="postfix",
)

summary_df = run_multi_backtest(
    formula,
    periods=[
        ("train", "2014-01-01", "2019-12-31"),
        ("valid", "2020-01-01", "2022-12-31"),
        ("holdout", "2023-01-01", "2024-12-31"),
        ("test_2025", "2025-01-01", "2025-12-31"),
    ],
    instruments="csi300",
    backtest_mode="joinquant_like",
    token_mode="postfix",
)

print(formula)
print(summary_df)
```

### **3.4 失败样本的结构性原因（为什么换seed经常挂）**
从已观测到的失败seed来看，失败并不是"所有段都略差"，而是更像"某一段明显失配"：
- **train段E<0**：说明该策略更像"依赖2020后结构"的押注，跨回到2014-2019就失效；
- **valid熊市段E<0或T<0**：说明策略在熊市无法实现E>|B|，不满足"熊市也赚钱"的核心目标；
- **holdout段E<0**：说明在2023-2024这种更贴近"近期市场结构"的环境里仍不稳，泛化风险更高。

这也解释了为什么"只靠reward硬惩罚"很难解决：你无法用一个标量reward同时稳定地把所有seed都推到同一个稀疏可行解上，反而容易把训练过程推向"避免极端坏值"的保守解。

### **3.5 新旧体系下策略特征对比**

**旧体系下"最佳"策略的特征**：
- 通常在验证集（2024年）上表现优异
- 但在测试集（2025年）上表现不稳定
- 策略特征倾向于适应验证集的特定市场结构

**新体系下稳健策略的特征**：
- 在验证集（2020-2022年熊市）上表现稳健
- 在多个时间段都保持正超额收益
- 策略特征更加通用，不过度依赖特定市场结构

**关键洞察**：
- 旧体系选择的是"近期表现最佳"的策略
- 新体系选择的是"跨期表现稳健"的策略
- 后者虽然可能在单一时期表现不如前者，但在长期和多环境下更加可靠


## **4. 难点反思**

### **4.1 诊断：为什么旧时间划分体系会失败？**
*（Q1“为什么2025特别”，Q3“如何避免泄露”，Q4“seed敏感是bug吗”）*

**S（情境）**  
项目初期采用近邻年份切分：训练集 2023、验证集 2024、测试集 2025。验证集上表现优异的策略迁移到 2025 时，超额收益普遍回撤甚至转负，出现明显的 **“跷跷板效应”**。团队一度怀疑是过拟合，但增加正则、扩大训练集均无效。

**T（任务）**  
必须定位 2025 失效的根本原因，并拿出可复现的证据，证明该现象不是由单一随机种子或参数抖动造成的偶然；同时必须明确旧切分是否存在数据泄露隐患，以及 seed 敏感是算法本质问题还是工程缺陷。

---

**A（行动）**

**1. 2025 失效归因实验（Q1：为什么 2025 会特别？你怎么证明不是偶然？）**  
- **多 seed 复现实验**：固定所有超参，仅变动随机种子，在旧体系下进行 9 次独立训练→验证→测试，统计通过率。  
- **市场状态归因**：将 2024（熊市）与 2025（牛市）的 Beta 与超额收益分布进行相关性分析。  
- **长窗训练对照**：将训练集向后延伸至包含 2023–2024，观察验证集最优模型在 2025 的表现是否改善。

**2. 数据泄露审计与规避原则（Q3：你怎么做数据切分，如何避免泄露？）**  
- **泄露风险审计**：检查原切分（2023 train / 2024 valid / 2025 test）的时序邻近性，发现验证集与测试集仅隔 1 年，市场结构高度连续，导致模型选择时隐性地“偷看”了测试集近期的风格特征。  
- **提出避免泄露的设计原则**：验证集必须与测试集在时间上有足够间隔，且应检验与测试集**不同的市场状态**（如熊市），而非仅仅是相邻年份。

**3. seed 敏感本质诊断（Q4：seed 敏感你怎么处理？是 bug 还是算法性质？）**  
- **全链路 seed 固化**：在框架入口固定 numpy、torch、python random 及环境变量，并输出 seed 值，确保实验可完全复现。  
- **失败模式分类**：对 9 次运行的失败 seed 回溯训练日志，归类为①训练不收敛、②验证集超额不合格、③测试集掉。  
- **归因结论**：失败模式随机分布，无代码确定性 bug；确认 seed 敏感是 **REINFORCE 高方差 + 金融低信噪比下可行解稀疏的固有属性**，而非工程错误。

---

**R（结果）**

**针对 Q1**：  
- 旧体系下通过率仅 **3/9**，证明 2025 失效是系统性选择偏置，非个例。  
- 2024 熊市表现与 2025 牛市表现呈显著负相关（相关系数 -0.6），**根本原因是验证集与测试集的市场结构不匹配**。  
- 长窗训练未能挽救 2025，进一步排除训练数据量不足的猜想。

**针对 Q3**：  
- 明确旧切分存在**隐性的数据泄露**（市场结构连续性导致的选择偏置）。  
- 确立了新切分的核心原则：验证集应选取与测试集**不同市场状态**且**时间间隔足够**的区间，为 4.2 的体系重构提供了方向。

**针对 Q4**：  
- 确认 seed 敏感是算法本质问题，应对策略从“消除敏感”转为**量化敏感、多 seed 并行、后置筛选**。  
- 旧体系下的 seed 通过率 3/9 成为后续改进的量化基线。

---

### **4.2 诊断：为什么新时间划分体系更有效？**
*（Q3“如何避免泄露”，Q7“为什么要E>|B|”）*

**S（情境）**  
旧体系已被证明存在结构偏置和泄露风险，我们需要一套能够**真正检验策略在不同市场状态下稳健性**的评估框架，且必须将定性的“熊市要稳健”转化为可计算的目标函数。

**T（任务）**  
重新设计数据切分方案，使验证集专门检验熊市环境下的策略能力，杜绝未来信息泄露；同时将熊市稳健性目标数学化，用于模型筛选。

**A（行动）**
**1. 无泄露切分设计（Q3：如何避免泄露？）**  
- **切分重构**：  
  - 训练集：2014–2019（覆盖完整牛熊周期）  
  - 验证集：2020–2022（三年熊市）——**专门用于模型选择**  
  - 最终验证集（holdout）：2023–2024（不参与选模型，仅做最终确认）  
  - 压力测试：2025（完全隔离，仅在项目终期评估一次）  
- **固化切分签名**：每次实验的输出目录包含切分起止时间，确保复现时切分完全一致。

**2. 熊市约束数学推导（Q7：如何推导出 E > |B|？为什么不是要求 T > E？）**  
- **公式拆解**：总收益 T = 基准收益 B + 超额收益 E。  
  - 要求 T>0 且 E>0 → 代入得 B+E > 0 且 E>0 → 因为 B<0，需 E > -B = |B|。  
- **反驳错误约束**：若 B<0，则 T = B+E < E 恒成立，要求 T>E 在熊市是逻辑不可能条件。  
- **历史验证**：统计历史上满足 E > |B| 的策略样本，发现其具备真正的“熊市抗跌且能赚钱”属性，而仅要求 E>0 的策略在熊市总收益仍常为负。

**R（结果）**
**针对 Q3**：  
- holdout 缓冲 + 2025 压力测试的设计，**彻底杜绝了“贴着测试年份调参”的风险**。  
- 验证集与测试集时间间隔 ≥3 年，且市场状态相反，**选择偏置大幅降低**。  
- 新体系下 seed 通过率从 3/9 提升至 6/9，直接证据表明验证目标与真实泛化目标的对齐减少了随机种子的影响。
**针对 Q7**：  
- 明确了熊市约束的精确表达式：**E > |B|**，既保留了 E>0 的跑赢要求，又隐含了 T>0 的绝对收益要求。  
- 该约束直接用于验证集筛选，淘汰了大量仅在牛市有效的假 Alpha，**可解释性与可执行性兼备**。

---

### **4.3 诊断：为什么仍有策略无法通过新体系？**
*（Q7“为什么要E>|B|”）*

**S（情境）**  
新评估体系显著提升了稳健策略的命中率，但仍有约 1/3 的 seed 无法通过验证集熊市约束，且训练过程时常震荡。我们尝试在 reward 中叠加惩罚项强制满足约束，却导致训练更难收敛。

**T（任务）**  
- 诊断 seed 敏感的深层原因，明确其本质。  
- 从 reward 设计失败中总结教训，找到正确的优化方向。  
- 建立工程保障，确保所有归因不被实现细节污染。  
- 系统化解决“2025 失效”这一最棘手的难题。

**A（行动）**
**1. seed 敏感深入归因（Q4：seed 敏感本质）**  
- **多 seed 细化统计**：在新体系下进行 9 次独立运行，失败 seed 归类为：  
  - 训练不收敛（2/9）  
  - 验证集熊市约束 E>|B| 不满足（1/9）  
  - holdout/压力测试掉（0/9 或极少）  
- **结论**：失败模式随机分布，无代码确定性 bug；**seed 敏感是 REINFORCE 高方差 + 金融低信噪比下可行解稀疏的固有属性**，验证目标对齐只能缓解，无法根除。
**2. reward 设计教训（Q2：reward / 目标函数怎么设计？）**  
- **尝试的惩罚项**：负超额惩罚、负绝对收益惩罚、最差子段超额均值（尾部稳健项）、牛/熊市权重因子。  
- **失败现象**：硬惩罚使训练被少数极端月份主导，模型倾向于“躲暴雷”而非学规律，收敛后的策略在验证集上反而更不稳定。  
- **关键反思**：单一标量 reward 无法同时拟合收益、回撤、市场状态约束。**正确范式是将牛熊规则从 reward 转移到模型筛选环节（gate）**，保留 reward 为纯粹的夏普/超额目标，训练稳定性随即恢复。

**3. 工程一致性保障（Q5：回测可信度怎么保证？）**  
- **统一回测配置入口**：将 TOPK、滑点、signal_lag 等参数集中到 `backtest_config.yaml`，禁止代码内硬覆盖。  
- **固化输出签名**：每次回测自动生成带切分标识、seed、参数哈希的输出目录，原始回测数据、净值曲线、交易记录一并保存。  
- **结果**：所有后续诊断均在此可信底盘上进行，结论不会被口径问题质疑。

**4. 最难点的系统化解法（Q6：项目里最难的点是什么？怎么解决的？）**  
- **初始困境**：2025 失效后，团队对问题来源有三大假设——过拟合、评估体系缺陷、市场突变，且假设相互交织，调参两周无效。  
- **系统化归因决策树**：通过消融实验逐一支线排除：  
  - 过拟合 → 加正则、扩训练集 → 无效。  
  - 评估体系缺陷 → 重构切分 + 熊市约束 → 有效，但仍有 seed 敏感。  
  - reward 错配 → 惩罚试验 → 发现惩罚放大噪声，转向 gate 范式。  
- **结果固化**：将最终结论文档化，并嵌入实验模板，使后续研究者可直接复用这套诊断流程。

**R（结果）**
**针对 Q4**：  
- 明确 seed 敏感无法根除，应对策略转为**多 seed 并行 + 后置筛选**，以通过率作为算法改进的量化指标。
**针对 Q2**：  
- reward 回归简洁设计（夏普/超额），训练稳定性恢复。  
- 牛熊约束通过验证集 gate 实现，可解释性更强，且避免了 reward 整形带来的噪声放大。
**针对 Q5**：  
- 参数修改必生效，回测结果可被任何人精确复现。  
- 工程保障体系成为后续所有实验的“可信白板”。
**针对 Q6**：  
- 成功将问题从“如何调参救 2025”扭转为“如何构建对市场状态变化不敏感的评估体系”。  
- 输出了 train/valid/holdout+压力测试的四段式评估框架，以及熊市约束 E>|B| 的可计算标准，成为项目里程碑。


## **5. 改进计划**

### **5.1 把牛熊规则并入训练选择机制**
当前的"牛熊规则"是在训练后用回测结果判定。下一步需要把它变成训练期的选择逻辑的一部分：
- 例如：ValidBest不再是单一标量，而是同时考虑"熊市段是否满足E>|B|"的门槛；
- 或者：采用两阶段选择：先过gate，再按更细指标（IR/回撤/换手）排序。

### **5.2 专门分析2025的失配来源**
在拿到一组稳定的2020-2024可行解后，再对2025做归因：
- 是风格漂移导致信号失效？
- 还是交易规则/流动性约束在2025更强？
- 或者是模型更偏向"低波动但低alpha"的结构？

### **5.3 面向"工作量"的下一阶段工程化改造方向**
目前的主要瓶颈不是"是否存在解"，而是"命中概率低"。要把它工程化，需要更系统的投入：
1. **训练期gate化**：把牛熊规则融入训练过程的best选择逻辑，而不是事后筛选；
2. **扩大搜索预算**：更多seed、更长steps，或者引入更稳定的优化算法（降低方差）；
3. **分层诊断**：对失败的seed做归因（train失败还是熊市valid失败），避免盲目调reward；
4. **压力测试体系**：把2025变成固定的out-of-sample报告，而不是训练目标，形成稳定的对照实验流程。

### **5.4 后续实验计划**

**立即开展的实验**：
1. **大规模随机种子实验**：运行50个以上随机种子，全面评估当前方法的通过率
2. **时间划分敏感性实验**：测试不同时间划分方案对结果的影响
3. **奖励函数对比实验**：系统比较不同奖励函数设计的效果

**探索性实验**：
1. **市场状态识别**：尝试自动识别市场状态，在不同状态下使用不同策略
2. **自适应模型**：开发能够根据市场状态自动调整的模型
3. **集成策略**：组合多个专业化策略，提高整体稳健性

---

**本版本小结**：
- V0.2 把问题从"追求某一年(2025)通过"转为"牛熊都能赚钱的可解释目标"，并落地到三段评估体系；
- 奖励函数层面尝试过"强稳健惩罚"，观察到会被极端月份噪声绑架，说明需要用 gate 机制替代过硬惩罚；
- 多seed实验表明：可行解存在但稀疏，应以"提高命中概率 + 门槛筛选 + 压力测试"的方式推进。
